<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Refugios Temporales Acapulco - Coyuca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Noto Sans', sans-serif;
      background-color: #f2f2f2;
      /* --- CAMBIO: Flexbox para el layout --- */
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #002f2a;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    
    header h1 { margin: 0; font-size: 1.4em; }
    header p { font-size: 0.9em; margin-top: 5px; line-height: 1.4; }

    #map {
      position: relative;
      width: 100%;
      max-height: 800px;
      z-index: 1;
      /* --- CAMBIO: Flexbox para que el mapa crezca --- */
      flex: 1;
    }
    
    #loader { /* ... estilos sin cambios ... */ }
    #locate-btn { /* ... estilos sin cambios ... */ }

    footer {
      text-align: center;
      padding: 10px 0;
      background-color: white;
    }

    footer img { max-width: 100%; height: auto; }
  </style>
</head>
<body>

  <header> </header>

  <div id="loader">Cargando datos...</div>
  <div id="map"></div>
  <button id="locate-btn" title="Encontrar mi ubicación">
    <img src="IMG/my-location.svg" alt="Mi ubicación"/>
  </button>

  <footer>
    <img src="IMG/footer.png" alt="Footer Institucional">
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const refugiosLayer = L.markerClusterGroup();
    const satelliteWithLabels = L.layerGroup([
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}')
    ]);

    const map = L.map('map', { layers: [satelliteWithLabels, refugiosLayer] });
    const loader = document.getElementById('loader');
    loader.style.display = 'block';

    let refugiosData = {};
    // --- CAMBIO: Ruta del archivo CSV ---
    Papa.parse("DATA/refugios.csv", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => { refugiosData[row.CLV] = row; });
        cargarGeojsonRefugios();
      }
    });

    function cargarGeojsonRefugios() {
      // --- CAMBIO: Ruta del archivo GeoJSON ---
      fetch("DATA/refugios.geojson")
        .then(res => res.json())
        .then(geojson => {
          L.geoJSON(geojson, {
            pointToLayer: function(feature, latlng) {
              const clave = feature.properties.CLAVE;
              const props = refugiosData[clave];
              if (!props) return null;

              const customIcon = L.icon({
                // --- CAMBIO: Ruta del ícono ---
                iconUrl: 'IMG/refugio.svg',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
              });

              const marker = L.marker(latlng, { icon: customIcon, title: props.Nombre });
              const popup = `<strong>${props.Nombre}</strong><br><b>Dirección:</b> ${props["Dirección"]}<br><b>Capacidad personas:</b> ${props["Capacidad de personas"]}`;
              marker.bindPopup(popup);
              refugiosLayer.addLayer(marker);
            }
          });

          map.fitBounds(refugiosLayer.getBounds());
          
          const searchControl = new L.Control.Search({
            layer: refugiosLayer, propertyName: 'title', marker: false,
            moveToLocation: (latlng, title, map) => map.setView(latlng, 16)
          });
          searchControl.on('search:locationfound', e => e.layer.openPopup());
          map.addControl(searchControl);
          
          loader.style.display = 'none';
        });
    }

    // Lógica del botón de geolocalización sin cambios...
  </script>
</body>
</html>
